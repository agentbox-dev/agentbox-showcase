'use client'

import React, { createContext, useContext, useState, useEffect } from 'react'
import { clientEnv } from '@/lib/env'
import { authApi, authApiHelpers, AuthApiError } from '@/lib/api/auth'
import { teamApiHelpers, Team } from '@/lib/api/team'
import { validateLoginResponse } from '@/lib/login-validator'
import { STORAGE_KEYS } from '@/constants'

// Âú®ÂºÄÂèëÊ®°Âºè‰∏ãÂä†ËΩΩÈ™åËØÅÂ∑•ÂÖ∑
if (typeof window !== 'undefined' && clientEnv.DEBUG_MODE) {
  import('@/lib/login-validator')
}

interface User {
  id: string
  email: string
  firstName: string
  lastName: string
  company?: string
  avatar?: string
}

interface AuthContextType {
  user: User | null
  isLoading: boolean
  isAuthenticated: boolean
  teams: Team[]
  defaultTeam: Team | null
  login: (email: string, password: string) => Promise<void>
  register: (userData: RegisterData) => Promise<void>
  logout: () => void
  updatePassword: (currentPassword: string, newPassword: string) => Promise<void>
  forgotPassword: (email: string) => Promise<void>
  resetPassword: (token: string, newPassword: string) => Promise<void>
  refreshToken: () => Promise<void>
  fetchTeams: (userId?: string) => Promise<void>
}

interface RegisterData {
  email: string
  password: string
  firstName?: string  // Optional, not used in backend
  lastName?: string   // Optional, not used in backend
  company?: string    // Optional, not used in backend
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [teams, setTeams] = useState<Team[]>([])
  const [defaultTeam, setDefaultTeam] = useState<Team | null>(null)

  useEffect(() => {
    // Check if user is logged in on app start
    const checkAuth = async () => {
      try {
        const token = localStorage.getItem('auth_token')
        const expiresAt = localStorage.getItem('token_expires_at')
        
        if (token && expiresAt) {
          // Check if token is expired
          const now = Date.now() / 1000
          const expires = parseInt(expiresAt)
          
          if (now < expires) {
            // Token is still valid, verify it with the server
            console.log('Valid token found, verifying with server...')
            try {
              // Try to get user teams to verify token is still valid
              const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}')
              if (userInfo.id) {
                await fetchTeams(userInfo.id)
                // If successful, set user as authenticated
                setUser(userInfo)
                console.log('Token verified successfully, user auto-logged in')
              } else {
                console.log('No user info found, clearing tokens')
                localStorage.removeItem('auth_token')
                localStorage.removeItem('refresh_token')
                localStorage.removeItem('token_expires_at')
                localStorage.removeItem('user_info')
              }
            } catch (error) {
              console.log('Token verification failed:', error)
              // Token is invalid, clean up
              localStorage.removeItem('auth_token')
              localStorage.removeItem('refresh_token')
              localStorage.removeItem('token_expires_at')
              localStorage.removeItem('user_info')
            }
          } else {
            // Token expired, clean up
            console.log('Token expired, cleaning up')
            localStorage.removeItem('auth_token')
            localStorage.removeItem('refresh_token')
            localStorage.removeItem('token_expires_at')
            localStorage.removeItem('user_info')
          }
        }
      } catch (error) {
        console.error('Auth check failed:', error)
        localStorage.removeItem('auth_token')
        localStorage.removeItem('refresh_token')
        localStorage.removeItem('token_expires_at')
      } finally {
        setIsLoading(false)
      }
    }

    checkAuth()
  }, [])

  const login = async (email: string, password: string) => {
    setIsLoading(true)
    try {
      console.log('üîç ÂºÄÂßãÁôªÂΩïÈ™åËØÅ...')
      console.log('üìß ÈÇÆÁÆ±:', email)
      console.log('üîë ÂØÜÁ†Å:', password ? '***' : '(Á©∫)')
      
      const response = await authApiHelpers.signIn(email, password)
      
      console.log('üìã ÁôªÂΩïAPIÂìçÂ∫î:', response)
      
      // È™åËØÅÂìçÂ∫îÁªìÊûÑ
      const validation = validateLoginResponse(response)
      
      if (!validation.isValid) {
        console.error('‚ùå ÁôªÂΩïÂìçÂ∫îÈ™åËØÅÂ§±Ë¥•:', validation.errors)
        throw new Error(`ÁôªÂΩïÂìçÂ∫îÊ†ºÂºèÈîôËØØ: ${validation.errors.join(', ')}`)
      }
      
      console.log('‚úÖ ÁôªÂΩïÂìçÂ∫îÈ™åËØÅÈÄöËøá')
      
      // Store tokens
      localStorage.setItem('auth_token', response.access_token)
      
      // Âè™ÊúâÂΩì refresh_token ‰∏çÊòØ "None" Êó∂ÊâçÂ≠òÂÇ®
      if (response.refresh_token && response.refresh_token !== "None") {
        localStorage.setItem('refresh_token', response.refresh_token)
      } else {
        localStorage.removeItem('refresh_token')
      }
      
      localStorage.setItem('token_expires_at', response.expires_at.toString())
      
      console.log('üíæ TokenÂ∑≤Â≠òÂÇ®Âà∞localStorage')
      console.log('   - access_token:', response.access_token.substring(0, 20) + '...')
      console.log('   - refresh_token:', response.refresh_token === "None" ? 'None (not stored)' : response.refresh_token.substring(0, 20) + '...')
      console.log('   - expires_at:', new Date(response.expires_at * 1000).toLocaleString())
      
      // Extract user data from response
      const userData = response.user
      const extractedUser = {
        id: userData.id || '1',
        email: userData.email || email,
        firstName: userData.first_name || userData.firstName || '',
        lastName: userData.last_name || userData.lastName || '',
        company: userData.company || '',
        avatar: userData.avatar || userData.avatar_url || ''
      }
      
      console.log('üë§ ÊèêÂèñÁöÑÁî®Êà∑Êï∞ÊçÆ:', extractedUser)
      setUser(extractedUser)
      
      // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØÂà∞localStorageÔºåÁî®‰∫éÈ°µÈù¢Âà∑Êñ∞ÂêéÊÅ¢Â§çÁä∂ÊÄÅ
      localStorage.setItem('user_info', JSON.stringify(extractedUser))
      
      // ÁôªÂΩïÊàêÂäüÂêéËé∑ÂèñÂõ¢ÈòüÂàóË°®ÔºåÁõ¥Êé•‰º†ÈÄíÁî®Êà∑ID
      await fetchTeams(extractedUser.id)
      
    } catch (error) {
      console.error('‚ùå ÁôªÂΩïÂ§±Ë¥•:', error)
      
      // Ê∏ÖÁêÜÂèØËÉΩÂ≠òÂú®ÁöÑÊó†Êïàtoken
      localStorage.removeItem('auth_token')
      localStorage.removeItem('refresh_token')
      localStorage.removeItem('token_expires_at')
      setUser(null)
      
      // ÂßãÁªàÊäõÂá∫ÈîôËØØÔºå‰∏çËøõË°åfallback
      throw error
    } finally {
      setIsLoading(false)
    }
  }

  const register = async (userData: RegisterData) => {
    setIsLoading(true)
    try {
      console.log('üîç ÂºÄÂßãÁî®Êà∑Ê≥®ÂÜå...')
      console.log('üìß ÈÇÆÁÆ±:', userData.email)
      
      const response = await authApiHelpers.signUp(userData.email, userData.password)
      
      console.log('üìã Ê≥®ÂÜåAPIÂìçÂ∫î:', response)
      console.log('‚úÖ Ê≥®ÂÜåÊàêÂäü!')
      
      // Ê≥®ÂÜåÊàêÂäüÂêé‰∏çËá™Âä®ÁôªÂΩïÔºåÁî®Êà∑ÈúÄË¶ÅÈáçÊñ∞ÁôªÂΩï
      // ‰∏çËÆæÁΩÆÁî®Êà∑Áä∂ÊÄÅÂíåtokenÔºåËÆ©Áî®Êà∑ÊâãÂä®ÁôªÂΩï
      
    } catch (error) {
      console.error('‚ùå Ê≥®ÂÜåÂ§±Ë¥•:', error)
      
      // Âú®ÂºÄÂèëÊ®°Âºè‰∏ãÔºåÂ¶ÇÊûúAPIÂ§±Ë¥•Ôºå‰πü‰∏çËá™Âä®ÁôªÂΩï
      if (clientEnv.DEBUG_MODE) {
        console.warn('API call failed in demo mode:', error)
        // Âú®demoÊ®°Âºè‰∏ã‰πü‰∏çËá™Âä®ËÆæÁΩÆÁî®Êà∑Áä∂ÊÄÅ
        // ËÆ©Áî®Êà∑ÊâãÂä®ÁôªÂΩï‰ª•‰øùÊåÅ‰∏ÄËá¥ÊÄß
      }
      
      throw error
    } finally {
      setIsLoading(false)
    }
  }

  const logout = () => {
    localStorage.removeItem('auth_token')
    localStorage.removeItem('refresh_token')
    localStorage.removeItem('token_expires_at')
    localStorage.removeItem('user_info')
    localStorage.removeItem(STORAGE_KEYS.CURRENT_TEAM_ID)
    setUser(null)
    setTeams([])
    setDefaultTeam(null)
  }

  const updatePassword = async (currentPassword: string, newPassword: string) => {
    setIsLoading(true)
    try {
      await authApiHelpers.updatePassword(currentPassword, newPassword)
    } catch (error) {
      throw error
    } finally {
      setIsLoading(false)
    }
  }

  const forgotPassword = async (email: string) => {
    setIsLoading(true)
    try {
      await authApiHelpers.forgotPassword(email)
    } catch (error) {
      throw error
    } finally {
      setIsLoading(false)
    }
  }

  const resetPassword = async (token: string, newPassword: string) => {
    setIsLoading(true)
    try {
      await authApiHelpers.resetPassword(token, newPassword)
    } catch (error) {
      throw error
    } finally {
      setIsLoading(false)
    }
  }

  const refreshToken = async () => {
    try {
      const refreshTokenValue = localStorage.getItem('refresh_token')
      if (!refreshTokenValue || refreshTokenValue === "None") {
        throw new Error('No refresh token available')
      }
      
      const response = await authApiHelpers.refreshToken(refreshTokenValue)
      
      // Update stored tokens
      localStorage.setItem('auth_token', response.access_token)
      
      // Âè™ÊúâÂΩì refresh_token ‰∏çÊòØ "None" Êó∂ÊâçÂ≠òÂÇ®
      if (response.refresh_token && response.refresh_token !== "None") {
        localStorage.setItem('refresh_token', response.refresh_token)
      } else {
        localStorage.removeItem('refresh_token')
      }
      
      localStorage.setItem('token_expires_at', response.expires_at.toString())
      
      // Update user data if available
      if (response.user) {
        const userData = response.user
        setUser({
          id: userData.id || '1',
          email: userData.email || user?.email || '',
          firstName: userData.first_name || userData.firstName || user?.firstName || '',
          lastName: userData.last_name || userData.lastName || user?.lastName || '',
          company: userData.company || user?.company || '',
          avatar: userData.avatar || userData.avatar_url || user?.avatar || ''
        })
      }
    } catch (error) {
      // If refresh fails, logout user
      logout()
      throw error
    }
  }

  const fetchTeams = async (userId?: string) => {
    try {
      const targetUserId = userId || user?.id
      if (!targetUserId) {
        throw new Error('Áî®Êà∑ID‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïËé∑ÂèñÂõ¢ÈòüÂàóË°®')
      }
      
      console.log('üîç Ëé∑ÂèñÁî®Êà∑Âõ¢ÈòüÂàóË°®...')
      console.log('üë§ Áî®Êà∑ID:', targetUserId)
      const teamsData = await teamApiHelpers.getUserTeams(targetUserId)
      console.log('üìã Âõ¢ÈòüÂàóË°®:', teamsData)
      
      setTeams(teamsData)
      
      // ËÆæÁΩÆÈªòËÆ§Âõ¢ÈòüÔºàÂè™ÊúâÂú®Ê≤°Êúâ‰øùÂ≠òÁöÑÂõ¢ÈòüIDÊó∂ÊâçËÆæÁΩÆÔºâ
      if (teamsData.length > 0) {
        const savedTeamId = typeof window !== 'undefined' ? localStorage.getItem(STORAGE_KEYS.CURRENT_TEAM_ID) : null
        
        if (savedTeamId) {
          // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑÂõ¢ÈòüIDÔºåÂ∞ùËØïÊâæÂà∞ÂØπÂ∫îÁöÑÂõ¢Èòü
          const savedTeam = teamsData.find(team => team.id === savedTeamId)
          if (savedTeam) {
            setDefaultTeam(savedTeam)
            console.log('‚úÖ ‰ΩøÁî®‰øùÂ≠òÁöÑÂõ¢Èòü:', savedTeam.name)
          } else {
            // ‰øùÂ≠òÁöÑÂõ¢ÈòüIDÊó†ÊïàÔºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™Âõ¢Èòü
            const defaultTeamToSet = teamsData[0]
            setDefaultTeam(defaultTeamToSet)
            localStorage.setItem(STORAGE_KEYS.CURRENT_TEAM_ID, defaultTeamToSet.id)
            console.log('‚ö†Ô∏è ‰øùÂ≠òÁöÑÂõ¢ÈòüIDÊó†ÊïàÔºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™Âõ¢Èòü:', defaultTeamToSet.name)
          }
        } else {
          // Ê≤°Êúâ‰øùÂ≠òÁöÑÂõ¢ÈòüIDÔºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™Âõ¢Èòü‰Ωú‰∏∫ÈªòËÆ§Âõ¢Èòü
          const defaultTeamToSet = teamsData[0]
          setDefaultTeam(defaultTeamToSet)
          localStorage.setItem(STORAGE_KEYS.CURRENT_TEAM_ID, defaultTeamToSet.id)
          console.log('‚úÖ ËÆæÁΩÆÈªòËÆ§Âõ¢Èòü:', defaultTeamToSet.name)
        }
      } else {
        setDefaultTeam(null)
        console.log('‚ö†Ô∏è Áî®Êà∑Ê≤°Êúâ‰ªª‰ΩïÂõ¢Èòü')
      }
    } catch (error) {
      console.error('‚ùå Ëé∑ÂèñÂõ¢ÈòüÂàóË°®Â§±Ë¥•:', error)
      // ‰∏çÂÜç‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆÔºåÁ°Æ‰øùÂè™ÊúâÁúüÊ≠£ÁôªÂΩïÊàêÂäüÊâçËÉΩËé∑ÂèñÂõ¢ÈòüÊï∞ÊçÆ
      throw error
    }
  }

  const value: AuthContextType = {
    user,
    isLoading,
    isAuthenticated: !!user,
    teams,
    defaultTeam,
    login,
    register,
    logout,
    updatePassword,
    forgotPassword,
    resetPassword,
    refreshToken,
    fetchTeams,
  }

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  )
}

export function useAuth() {
  const context = useContext(AuthContext)
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider')
  }
  return context
}
